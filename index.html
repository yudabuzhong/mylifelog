<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Lifelog - 2026 Sticker Booth</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;900&family=Jura:wght@500;700&family=Press+Start+2P&family=Playfair+Display:ital,wght@1,600;1,900&family=Oswald:wght@500;700&family=VT323&display=swap');

        /* Base Settings */
        body { 
            transition: background 0.5s ease; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior-y: none;
            background-color: #f0f0f0;
        }
        
        .no-select { user-select: none; -webkit-user-select: none; }
        .prevent-scroll { touch-action: none; }
        
        /* Layout Containers */
        .layout-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
        }
        
        .layout-strip-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
        }

        /* --- THEMES --- */
        /* CUTE */
        .theme-cute-bg { background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); }
        .theme-cute-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 4px solid #fff;
            border-radius: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .theme-cute-btn {
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border: 2px solid #fff;
            color: #8faaff;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            box-shadow: 4px 4px 10px rgba(166, 180, 200, 0.2), -4px -4px 10px rgba(255, 255, 255, 0.8);
        }
        
        /* FUJI */
        .theme-fuji-bg { background-color: #2c2c2c; background-image: repeating-linear-gradient(45deg, #333 0, #333 1px, transparent 0, transparent 50%); background-size: 10px 10px; }
        .theme-fuji-panel {
            background: #1a1a1a;
            border-top: 2px solid #555;
            border-bottom: 4px solid #000;
            border-radius: 6px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .theme-fuji-btn {
            background: #333; border: 1px solid #555; color: #d4d4d4;
            border-radius: 2px; font-family: 'Oswald', sans-serif; text-transform: uppercase;
            box-shadow: inset 1px 1px 0 rgba(255,255,255,0.1), 2px 2px 5px rgba(0,0,0,0.5);
        }
        .fuji-frame-bg { background-color: #111; border: 8px solid #000; }
        .fuji-sprocket-grid { border-left: 4px dashed #333; border-right: 4px dashed #333; }
        .fuji-date-glow {
            font-family: 'VT323', monospace;
            color: #ffaa00;
            text-shadow: 0 0 2px #ff5500, 0 0 5px #ff0000;
            letter-spacing: 2px;
        }

        /* CYBER */
        .theme-cyber-bg { background-color: #000; background-image: linear-gradient(rgba(50, 255, 0, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(50, 255, 0, 0.1) 1px, transparent 1px); background-size: 30px 30px; }
        .theme-cyber-panel {
            background: #050505; border: 1px solid #32ff00;
            box-shadow: 0 0 15px rgba(50, 255, 0, 0.2); border-radius: 0;
        }
        .theme-cyber-btn {
            background: transparent; border: 1px solid #32ff00; color: #32ff00;
            font-family: 'Jura', sans-serif; text-transform: uppercase; font-weight: bold;
        }
        .cyber-scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; pointer-events: none;
        }

        /* FILTERS */
        .filter-cute img { filter: brightness(1.1) contrast(1.05) saturate(1.1) sepia(0.1); }
        .filter-fuji img { filter: grayscale(30%) contrast(1.1) brightness(0.9) sepia(0.3); }
        .filter-cyber img { filter: contrast(1.4) saturate(1.6) hue-rotate(15deg); }

        .hidden-input { display: none; }
        #loading { position: fixed; inset: 0; background: #f0f0f0; z-index: 9999; display: flex; justify-content: center; align-items: center; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">åŠ è½½èµ„æºä¸­...</div>
    <div id="root"></div>

    <script type="text/babel">
        setTimeout(() => {
            const loader = document.getElementById('loading');
            if(loader) loader.style.display = 'none';
        }, 1000);

        const { useState, useRef, useEffect } = React;

        // Icons
        const Icon = ({ size = 20, children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const GridIcon = (props) => <Icon {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></Icon>;
        const StripIcon = (props) => <Icon {...props}><rect x="6" y="3" width="12" height="18" rx="2" /><line x1="6" y1="7.5" x2="18" y2="7.5" /><line x1="6" y1="12" x2="18" y2="12" /><line x1="6" y1="16.5" x2="18" y2="16.5" /></Icon>;
        const Layers = (props) => <Icon {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;
        const Dice = (props) => <Icon {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></Icon>;
        const RefreshCcw = (props) => <Icon {...props}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;

        // Data & Themes
        const STICKER_SETS = {
            cute: ['ğŸ€', 'ğŸŒˆ', 'ğŸ’', 'ğŸ§¸', 'ğŸ’–', 'âœ¨', 'ğŸ°', 'ğŸ­'],
            fuji: ['ğŸ“¸', 'ğŸï¸', 'ğŸ“…', 'ğŸ—»', 'â˜•', 'ğŸ‚', 'ğŸš²', 'ğŸ¹'],
            cyber: ['ğŸ‘¾', 'ğŸ’¿', 'âš¡', 'ğŸ¤–', 'ğŸ•¶ï¸', 'ğŸ’Š', 'ğŸ›¸', 'ğŸŒŒ']
        };
        const TEXT_PRESETS = {
            cute: ["Sweet Day", "Love You", "XOXO", "Besties", "So Cute!", "Happy!", "My Girl", "Pink Mood"],
            fuji: ["NO.001", "FILM RECORD", "KODAK PORTRA", "JAN 2026", "FUJICOLOR", "DAILY LOG", "NEGATIVE"],
            cyber: ["SYS.2026", "GLITCH", "ERROR 404", "ACID_MODE", "CYBER.LOG", "DATA LOST", "NEON CITY"]
        };
        const THEMES = {
            cute: { 
                name: 'Cute', 
                frameClass: 'bg-white rounded-2xl shadow-lg border-[6px] border-white',
                panelClass: 'theme-cute-panel', btnClass: 'theme-cute-btn',
                textColor: 'text-indigo-500', labelColor: 'text-gray-500', fontClass: 'font-[Fredoka]',
                dateStyle: 'text-gray-400 font-[Fredoka] text-[10px]',
                decor: <div className="absolute top-2 left-2 text-2xl animate-pulse z-40 drop-shadow-md">â˜ï¸</div>
            },
            fuji: { 
                name: 'Fuji', 
                frameClass: 'fuji-frame-bg shadow-2xl rounded-sm',
                panelClass: 'theme-fuji-panel', btnClass: 'theme-fuji-btn',
                textColor: 'text-yellow-500', labelColor: 'text-gray-400', fontClass: 'font-mono',
                dateStyle: 'fuji-date-glow text-right text-xs',
                decor: <div className="absolute top-2 right-2 text-[8px] text-white/50 border border-white/30 px-1 font-mono tracking-widest z-40">ISO 400</div>
            },
            cyber: { 
                name: 'Cyber', 
                frameClass: 'bg-black border border-[#32ff00] shadow-[0_0_20px_rgba(50,255,0,0.3)]',
                panelClass: 'theme-cyber-panel', btnClass: 'theme-cyber-btn',
                textColor: 'text-[#32ff00]', labelColor: 'text-[#32ff00]', fontClass: 'font-[Jura]',
                dateStyle: 'text-[#32ff00] font-[Jura] text-[10px] tracking-widest opacity-80',
                decor: (
                    <>
                        <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#32ff00] to-transparent z-40 opacity-50"></div>
                        <div className="absolute inset-0 cyber-scanlines z-30 opacity-20 pointer-events-none"></div>
                    </>
                )
            }
        };

        const HeaderLogo = ({ theme }) => {
            const styles = {
                cute: (<div className="flex flex-col items-center"><h1 className="text-4xl font-[Fredoka] font-black text-pink-400 tracking-wide" style={{ textShadow: '2px 2px 0px #e0c3fc, 4px 4px 0px rgba(255,255,255,0.5)' }}>LIFELOG <span className="text-2xl">2026</span></h1><div className="w-16 h-1 bg-gradient-to-r from-purple-300 to-pink-300 rounded-full mt-1"></div></div>),
                fuji: (<div className="flex items-center gap-3 border-[3px] border-[#d4d4d4] px-4 py-2 bg-[#1a1a1a] shadow-lg rounded-sm"><div className="w-6 h-6 rounded-full bg-red-600 border-2 border-white/20 shadow-inner flex items-center justify-center"><div className="w-2 h-2 bg-white/50 rounded-full blur-[1px]"></div></div><div className="flex flex-col leading-none"><span className="text-2xl font-[Oswald] font-bold text-[#d4d4d4] tracking-tighter uppercase transform scale-y-110">Lifelog</span><span className="text-[10px] text-red-600 font-bold tracking-[0.4em] uppercase text-right w-full block -mt-1">2026</span></div></div>),
                cyber: (<div className="relative border border-[#32ff00] px-4 py-1 bg-black skew-x-[-10deg]"><span className="block text-3xl font-[Jura] font-black tracking-tighter text-[#32ff00] skew-x-[10deg] drop-shadow-[0_0_5px_rgba(50,255,0,0.8)]">LIFELOG_2026</span><span className="absolute -top-3 -right-3 text-[10px] bg-[#32ff00] text-black px-1 font-bold skew-x-[10deg]">v2.6</span></div>)
            };
            return styles[theme] || styles.cute;
        };

        const App = () => {
            const loadState = (key, def) => localStorage.getItem(key) || def;
            const [layout, setLayout] = useState('grid');
            const [theme, setTheme] = useState(() => loadState('lifelog_theme', 'fuji'));
            const [customText, setCustomText] = useState(() => loadState('lifelog_text', 'SWEET DAY'));
            const [dateText, setDateText] = useState(() => loadState('lifelog_date', new Date().toLocaleDateString('en-CA').replace(/-/g, '.')));
            const [images, setImages] = useState(Array(4).fill({ url: null, x: 0, y: 0, scale: 1 }));
            const [stickers, setStickers] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [activeSlot, setActiveSlot] = useState(null);
            const [activeStickerId, setActiveStickerId] = useState(null);
            const [generatedImage, setGeneratedImage] = useState(null);
            const frameRef = useRef(null);
            const batchInputRef = useRef(null);
            const singleInputRef = useRef(null);
            const dragStartRef = useRef({ x: 0, y: 0 });
            const isDraggingImageRef = useRef(false);
            const isDraggingStickerRef = useRef(false);

            useEffect(() => { document.body.className = `theme-${theme}-bg`; localStorage.setItem('lifelog_theme', theme); }, [theme]);
            useEffect(() => { localStorage.setItem('lifelog_text', customText); }, [customText]);
            useEffect(() => { localStorage.setItem('lifelog_date', dateText); }, [dateText]);

            const getClientCoords = (e) => (e.touches && e.touches.length > 0) ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            
            const handleImageStart = (e, index) => { if (!images[index].url) return; const { x, y } = getClientCoords(e); setActiveSlot(index); setActiveStickerId(null); isDraggingImageRef.current = true; dragStartRef.current = { x: x - images[index].x, y: y - images[index].y }; };
            const handleStickerStart = (e, stickerId) => { e.stopPropagation(); const { x, y } = getClientCoords(e); setActiveStickerId(stickerId); setActiveSlot(null); isDraggingStickerRef.current = true; if(frameRef.current) { const rect = frameRef.current.getBoundingClientRect(); dragStartRef.current = { x, y, initialPctX: stickers.find(s=>s.id===stickerId).x, initialPctY: stickers.find(s=>s.id===stickerId).y, width: rect.width, height: rect.height }; }};
            const handleMove = (e) => {
                if (!isDraggingImageRef.current && !isDraggingStickerRef.current) return;
                const { x, y } = getClientCoords(e);
                if (isDraggingImageRef.current && activeSlot !== null) { e.preventDefault(); const newX = x - dragStartRef.current.x; const newY = y - dragStartRef.current.y; setImages(prev => { const u = [...prev]; u[activeSlot] = { ...u[activeSlot], x: newX, y: newY }; return u; }); }
                if (isDraggingStickerRef.current && activeStickerId !== null) { e.preventDefault(); const { x: sx, y: sy, initialPctX, initialPctY, width, height } = dragStartRef.current; setStickers(prev => prev.map(s => s.id === activeStickerId ? { ...s, x: initialPctX + ((x - sx)/width)*100, y: initialPctY + ((y - sy)/height)*100 } : s)); }
            };
            const handleEnd = () => { isDraggingImageRef.current = false; isDraggingStickerRef.current = false; };
            const handleWheel = (e) => {
                if (activeSlot !== null) { const delta = -e.deltaY * 0.001; setImages(prev => { const u = [...prev]; u[activeSlot].scale = Math.max(0.5, Math.min(3, u[activeSlot].scale + delta)); return u; }); }
            };

            const validateAndLoadImage = (file) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    img.onload = () => {
                        if (img.width < 300 || img.height < 300) {
                            alert(`å›¾ç‰‡å°ºå¯¸å¤ªå° (${img.width}x${img.height})ï¼Œå»ºè®®ä¸Šä¼ å¤§äº 300x300 çš„å›¾ç‰‡`);
                            resolve(null);
                        } else {
                            resolve(url); 
                        }
                    };
                    img.src = url;
                });
            };

            const handleBatchUpload = async (e) => {
                const files = Array.from(e.target.files).slice(0, 4);
                for (let i = 0; i < files.length; i++) {
                    const result = await validateAndLoadImage(files[i]);
                    if (result) {
                        setImages(prev => { const u = [...prev]; u[i] = { url: result, x: 0, y: 0, scale: 1 }; return u; });
                    }
                }
            };

            const handleSingleUpload = async (e) => {
                if (activeSlot === null || !e.target.files[0]) return;
                const result = await validateAndLoadImage(e.target.files[0]);
                if (result) {
                    setImages(prev => { const u = [...prev]; u[activeSlot] = { ...u[activeSlot], url: result, x: 0, y: 0, scale: 1 }; return u; });
                }
            };

            const generateStickers = () => { const set = STICKER_SETS[theme]; setStickers(Array(4).fill(0).map(()=>({ id: Math.random(), content: set[Math.floor(Math.random()*set.length)], x: Math.random()*80+5, y: Math.random()*80+5, rotation: Math.random()*40-20, scale: Math.random()*0.5+0.8 }))); };
            const generateRandomText = () => { const presets = TEXT_PRESETS[theme]; setCustomText(presets[Math.floor(Math.random() * presets.length)]); };

            // --- FIXED: DOM CLONING & SANDBOX STRATEGY ---
            const handleDownload = async () => {
                setIsGenerating(true);
                setActiveSlot(null); setActiveStickerId(null);
                
                await document.fonts.ready;
                await new Promise(r => setTimeout(r, 200));

                try {
                    const originalFrame = frameRef.current;
                    const clone = originalFrame.cloneNode(true);
                    
                    // Force strict dimensions on the clone to prevent squash
                    const W = layout === 'strip' ? 200 : 320;
                    const H = layout === 'strip' ? 800 : 400;
                    
                    clone.style.width = `${W}px`;
                    clone.style.height = `${H}px`;
                    clone.style.transform = 'none';
                    clone.style.margin = '0';
                    clone.style.boxShadow = 'none';
                    clone.style.borderRadius = '0'; // Clean edges
                    
                    // Create invisible sandbox
                    const sandbox = document.createElement('div');
                    Object.assign(sandbox.style, {
                        position: 'fixed', top: '0', left: '0', 
                        width: `${W}px`, height: `${H}px`,
                        zIndex: '-9999', // Hide behind everything
                        visibility: 'visible', overflow: 'hidden'
                    });
                    
                    // Ensure clone background matches theme for transparency safety
                    if (theme === 'fuji') sandbox.style.backgroundColor = '#1a1a1a';
                    else if (theme === 'cyber') sandbox.style.backgroundColor = '#000';
                    else sandbox.style.backgroundColor = '#fff';

                    sandbox.appendChild(clone);
                    document.body.appendChild(sandbox);
                    
                    // Wait for render
                    await new Promise(r => setTimeout(r, 300));

                    const canvas = await html2canvas(clone, { 
                        scale: 4, 
                        useCORS: true,
                        backgroundColor: null,
                        width: W, height: H,
                        windowWidth: 1600, // Force Desktop layout logic
                        logging: false
                    });
                    
                    document.body.removeChild(sandbox);
                    
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
                    if (isMobile) {
                        setGeneratedImage(dataUrl);
                    } else {
                        const link = document.createElement('a');
                        link.download = `lifelog_${theme}_${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                    }

                } catch(e) { console.error(e); alert("ä¿å­˜å‡ºé”™ï¼Œè¯·é‡è¯•"); } 
                finally { setIsGenerating(false); }
            };
            
            const t = THEMES[theme];
            const frameW = layout === 'strip' ? 200 : 320;
            const frameH = layout === 'strip' ? 800 : 400;
            const frameStyle = { width: `${frameW}px`, height: `${frameH}px`, transformOrigin: 'top center' };

            return (
                <div className={`min-h-screen flex items-center justify-center p-4 theme-transition ${isGenerating?'printing':''}`} onMouseMove={handleMove} onMouseUp={handleEnd} onMouseLeave={handleEnd} onTouchMove={handleMove} onTouchEnd={handleEnd} onWheel={handleWheel}>
                    <div className={`flex flex-col md:flex-row gap-0 max-w-4xl w-full mx-auto ${t.panelClass} transition-all duration-300`}>
                        {/* LEFT AREA */}
                        <div className="flex-1 p-6 md:p-8 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-gray-300/10 overflow-hidden">
                            <div className="mb-6"><HeaderLogo theme={theme} /></div>
                            <div className="w-full flex justify-center overflow-hidden" style={{minHeight:'400px'}}>
                                <div className="scale-[0.75] md:scale-100 origin-top transition-transform no-select">
                                    <div ref={frameRef} className={`relative p-4 overflow-hidden flex flex-col shrink-0 ${t.frameClass}`} style={frameStyle}>
                                        {t.decor}
                                        <div className={`w-full flex-1 gap-2 ${layout==='grid'?'layout-grid-container':'layout-strip-container'} ${theme==='fuji'?'fuji-sprocket-grid':''}`}>
                                            {images.map((img,i)=>(
                                                <div key={i} className={`relative overflow-hidden group flex items-center justify-center prevent-scroll w-full h-full ${activeSlot===i?'ring-2 ring-offset-1 z-20 '+(theme==='cyber'?'ring-[#32ff00]':'ring-red-500'):''} filter-${theme} ${theme==='fuji'?'bg-[#1a1a1a]':'bg-gray-100'}`}
                                                    onMouseDown={(e)=>handleImageStart(e,i)} onTouchStart={(e)=>handleImageStart(e,i)} onClick={()=>!img.url && singleInputRef.current.click()}>
                                                    {img.url ? <><img src={img.url} className="absolute inset-0 w-full h-full object-cover pointer-events-none block" style={{transform:`translate(${img.x}px,${img.y}px) scale(${img.scale})`, minWidth:'100.5%', minHeight:'100.5%'}}/><button onClick={(e)=>{e.stopPropagation();setActiveSlot(i);setTimeout(()=>singleInputRef.current.click(),0)}} onTouchEnd={(e)=>{e.stopPropagation();setActiveSlot(i);setTimeout(()=>singleInputRef.current.click(),0)}} className="absolute top-1 right-1 p-1.5 rounded-full z-50 bg-white/80 text-black opacity-0 group-hover:opacity-100"><RefreshCcw size={14}/></button></> : <div className="font-black text-xl opacity-20">{i+1}</div>}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="absolute inset-0 z-40 pointer-events-none">{stickers.map(s=>(<div key={s.id} onMouseDown={(e)=>handleStickerStart(e,s.id)} onTouchStart={(e)=>handleStickerStart(e,s.id)} className={`absolute sticker-enter text-3xl cursor-grab pointer-events-auto prevent-scroll ${activeStickerId===s.id?'opacity-80':''}`} style={{left:`${s.x}%`, top:`${s.y}%`, transform:`rotate(${s.rotation}deg) scale(${s.scale||1})`}}>{s.content}</div>))}</div>
                                        <div className="mt-4 pb-2 flex flex-col items-center justify-center z-30 relative pointer-events-none shrink-0 w-full"><div className={`text-center font-bold uppercase tracking-widest px-2 break-words w-full ${t.textColor} ${t.fontClass}`}>{customText}</div><div className={`tracking-widest mt-1 opacity-90 ${t.dateStyle}`}>{dateText}</div></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4 mt-6">
                                <button onClick={()=>setLayout('grid')} className={`px-4 py-2 rounded text-xs font-bold border flex items-center gap-2 ${t.btnClass} ${layout==='grid'?'opacity-100 ring-2':'opacity-50'}`}><GridIcon size={14}/> å››å®«æ ¼</button>
                                <button onClick={()=>setLayout('strip')} className={`px-4 py-2 rounded text-xs font-bold border flex items-center gap-2 ${t.btnClass} ${layout==='strip'?'opacity-100 ring-2':'opacity-50'}`}><StripIcon size={14}/> å››è¿æ‹</button>
                            </div>
                        </div>

                        {/* RIGHT AREA */}
                        <div className="w-full md:w-[320px] p-6 flex flex-col justify-center gap-5 backdrop-blur-sm">
                            <div><h3 className={`text-[10px] font-bold uppercase mb-2 ${t.labelColor}`}>é£æ ¼ / STYLE</h3><div className="flex gap-2">{Object.entries(THEMES).map(([k,v])=><button key={k} onClick={()=>setTheme(k)} className={`flex-1 py-2 text-[10px] font-bold border ${theme===k?'ring-2':'opacity-60'} ${t.btnClass}`}>{v.name}</button>)}</div></div>
                            <div><h3 className={`text-[10px] font-bold uppercase mb-2 ${t.labelColor} flex justify-between`}><span>ä¸Šä¼ å›¾ç‰‡ / UPLOAD</span>{activeSlot!==null&&<span className="bg-black text-white px-1 rounded">#{activeSlot+1}</span>}</h3><button onClick={()=>batchInputRef.current.click()} className={`w-full py-2.5 flex justify-center items-center gap-2 font-bold text-xs ${t.btnClass}`}><Layers size={14}/> ä¸€é”®å¡«æ»¡ (4å¼ )</button></div>
                            <div>
                                <h3 className={`text-[10px] font-bold uppercase mb-2 ${t.labelColor}`}>è£…é¥° / DECOR</h3>
                                <div className="flex gap-2 mb-2"><input type="text" value={customText} onChange={e=>setCustomText(e.target.value)} className={`flex-1 bg-transparent border-b-2 outline-none text-xs font-bold ${t.textColor} ${theme==='fuji'?'border-gray-600':'border-gray-300'}`}/><button onClick={generateRandomText} className={`px-3 rounded ${t.btnClass}`}><Dice size={16}/></button></div>
                                <div className="mb-4"><input type="text" value={dateText} onChange={e=>setDateText(e.target.value)} className={`w-full bg-transparent border-b-2 outline-none text-xs font-bold text-center ${t.textColor} ${theme==='fuji'?'border-gray-600':'border-gray-300'}`}/></div>
                                <div className="grid grid-cols-4 gap-2 mb-6"><button onClick={generateStickers} className={`col-span-3 py-2.5 font-bold text-xs flex justify-center gap-2 ${t.btnClass}`}><Sparkles size={14}/> éšæœºè´´çº¸</button><button onClick={()=>setStickers([])} className={`col-span-1 py-2.5 flex justify-center ${t.btnClass}`}><Trash2 size={14}/></button></div>
                                <button onClick={handleDownload} disabled={isGenerating} className={`w-full py-4 font-black text-sm uppercase flex justify-center gap-2 hover:opacity-90 ${theme==='cyber'?'bg-[#32ff00] text-black':'bg-black text-white rounded-xl'}`}>{isGenerating?'ç”Ÿæˆä¸­...':<><Download size={16}/> ä¿å­˜å›¾ç‰‡</>}</button>
                            </div>
                        </div>
                    </div>

                    {generatedImage && <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 p-6 backdrop-blur-sm" onClick={()=>setGeneratedImage(null)}><div className="relative flex flex-col items-center gap-4 animate-popIn"><img src={generatedImage} className="rounded shadow-2xl max-h-[70vh] border-2 border-white/20"/><div className="text-white text-center"><p className="font-bold text-lg">âœ¨ å›¾ç‰‡å·²ç”Ÿæˆï¼</p><p className="text-xs opacity-70">è¯·é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</p></div><button className="mt-2 w-10 h-10 flex items-center justify-center rounded-full bg-white/20 text-white"><X size={20}/></button></div></div>}
                    <input type="file" multiple ref={batchInputRef} onChange={handleBatchUpload} accept="image/*" className="hidden-input"/><input type="file" ref={singleInputRef} onChange={handleSingleUpload} accept="image/*" className="hidden-input"/>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>